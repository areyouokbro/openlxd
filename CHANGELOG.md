# OpenLXD 更新日志

所有重要的项目变更都将记录在此文件中。

## [3.2.0-beta] - 2026-01-04 - 容器迁移功能（Beta版）

### 🎉 重大更新

实现容器迁移功能框架，包括迁移任务管理、远程主机配置、迁移日志记录和Web管理界面。

### ✨ 新功能

- **迁移任务管理**
  - 创建迁移任务（支持离线迁移）
  - 任务状态跟踪（pending, running, completed, failed, cancelled, rollback）
  - 进度实时显示（0-100%）
  - 任务取消功能
  - 任务回滚功能

- **远程主机管理**
  - 添加/删除远程 LXD 主机
  - 主机连接配置（地址、端口、证书）
  - 主机状态管理

- **日志系统**
  - 详细的迁移日志记录
  - 日志级别（info, warning, error）
  - 实时日志查看

- **Web 管理界面**
  - 迁移任务列表和状态展示
  - 进度条显示
  - 迁移日志查看
  - 远程主机配置管理
  - 创建迁移任务界面

### 💾 数据库更新

- 新增 `migration_tasks` 表 - 迁移任务管理
- 新增 `remote_hosts` 表 - 远程主机配置
- 新增 `migration_logs` 表 - 迁移日志记录

### 📦 API 接口

- `GET /api/migration/tasks` - 获取迁移任务列表
- `GET /api/migration/task` - 获取单个迁移任务
- `POST /api/migration/create` - 创建迁移任务
- `GET /api/migration/logs` - 获取迁移日志
- `POST /api/migration/cancel` - 取消迁移任务
- `POST /api/migration/rollback` - 回滚迁移
- `GET /api/migration/hosts` - 获取远程主机列表
- `POST /api/migration/host/create` - 添加远程主机
- `POST /api/migration/host/delete` - 删除远程主机

### 📈 项目进展

- 功能完整度：85% → **90%**（框架）
- 代码行数：+1,000 行
- 二进制文件：16MB → 24MB
- API 端点：23 → 32

### ⚠️ Beta 版本说明

**已实现：**
- ✅ 完整的数据模型和 API 接口
- ✅ Web 管理界面
- ✅ 远程主机配置管理
- ✅ 迁移任务创建和状态跟踪
- ✅ 日志记录和查看

**开发中：**
- ⚠️ 离线迁移核心逻辑（框架已搭建，需完善）
- ⚠️ 在线迁移（Live Migration）
- ⚠️ 容器数据卷迁移
- ⚠️ 网络配置迁移

### 📝 已知限制

- 当前版本的迁移逻辑尚未完全实现
- 创建迁移任务后会返回"迁移功能尚在开发中"的错误
- 建议使用 LXD 的导出/导入功能手动迁移
- 远程主机连接默认跳过 TLS 证书验证
- 大容器迁移可能耗时较长
- 暂无进度条实时更新（需要轮询）

### 🚀 下一步计划

- 完善离线迁移逻辑
- 实现实时进度更新（WebSocket）
- 迁移前检查（磁盘空间、网络连接）
- TLS 证书验证和主机认证

---

## [3.1.0] - 2026-01-04 - Web 界面完善更新

### 🎉 重大更新

完善 Web 管理界面，新增快照、克隆、DNS 设置页面，集成 Chart.js 实现监控图表可视化。Web 界面功能完整度从 40% 提升到 85%。

### ✨ 新功能

- **快照管理 Web 界面**
  - 容器选择器
  - 快照列表展示
  - 创建快照模态框
  - 恢复/删除快照功能

- **克隆管理 Web 界面**
  - 克隆容器模态框
  - 源容器选择
  - 从快照克隆选项
  - 目标容器名称输入

- **DNS 设置 Web 界面**
  - 容器选择器
  - DNS 服务器列表编辑
  - 常用 DNS 服务器参考
  - 保存 DNS 配置

- **监控图表可视化**
  - CPU 使用率趋势图
  - 内存使用率趋势图
  - 磁盘使用率趋势图
  - 网络速率趋势图
  - 最近 1 小时历史数据展示
  - 自动刷新图表（每 30 秒）

### 📦 新增文件

- `web/static/advanced.js` - 高级功能 JavaScript（约 450 行）
- `WEB_UI_UPDATE.md` - Web 界面更新说明

### 🔧 修改文件

- `web/templates/dashboard.html` - 添加新标签页和图表容器
- `web/static/dashboard.js` - 更新标签页切换逻辑
- `web/static/monitor.js` - 重写监控模块，添加图表功能

### 📈 项目进展

- Web 界面功能完整度：40% → **85%**
- JavaScript 代码：~800 行 → ~1,300 行 (+500 行)
- 标签页数量：7 → 10 (+3)
- 集成 Chart.js 4.4.1

### 📝 已知限制

- 图表仅显示最近 1 小时数据
- 需要至少 2 个数据点才能绘制图表
- 克隆操作没有进度条显示
- DNS 设置需要容器重启才能生效

---

## [3.0.0-final] - 2026-01-04 - 第5阶段完成（正式版）

### 🎉 重大更新

实现了高级功能，包括容器快照、克隆、DNS设置、命令执行和资源限制管理。项目功能完整度达到 95%，具备生产环境使用条件。

### ✨ 新功能

- **容器快照管理**
  - 创建容器快照（支持有状态/无状态）
  - 列出容器的所有快照
  - 恢复容器到指定快照
  - 删除和重命名快照

- **容器克隆功能**
  - 克隆容器（完整复制）
  - 从快照克隆容器
  - 复制容器（带自定义配置）

- **DNS 设置功能**
  - 设置容器 DNS 服务器
  - 获取容器 DNS 配置
  - 通用配置项管理

- **命令执行功能**
  - 在容器中执行命令
  - 支持自定义环境变量

- **资源限制管理**
  - 设置容器 CPU 限制
  - 设置容器内存限制
  - 设置容器磁盘限制

### 📦 API 接口

- `GET/POST/PUT/DELETE /api/snapshots` - 快照管理
- `POST /api/clone` - 克隆容器
- `GET/POST /api/dns` - DNS 设置
- `POST /api/exec` - 执行命令
- `POST /api/limits` - 设置资源限制

### 📈 项目进展

- 功能完整度：80% → **95%**
- 代码行数：+740 行
- 二进制文件：16MB → 23MB
- API 端点：18 → 23

### 📝 已知限制

- 未实现 VNC 控制台
- 未实现系统热更新
- 命令执行不支持交互式终端
- 高级功能的 Web 界面未完成

---

## [3.0.0-stage4] - 2026-01-04 - 第4阶段完成

### 🎉 重大更新

实现了实时监控系统，包括系统监控数据采集、历史数据存储、容器资源统计和Web监控界面。

### ✨ 新功能

- **监控数据采集**
  - 系统 CPU 使用率采集
  - 系统内存使用情况采集
  - 系统磁盘使用情况采集
  - 网络速率采集
  - 系统负载采集
  - 每 5 分钟自动采集

- **监控数据存储**
  - 系统指标历史数据
  - 容器指标历史数据
  - 网络流量统计
  - 自动清理 7 天前的旧数据

- **容器资源统计**
  - CPU 平均/最大使用率
  - 内存平均/最大使用率
  - 磁盘平均/最大使用率
  - 网络流量统计
  - 资源使用情况（IP/端口/代理）

- **Web 监控界面**
  - 实时系统指标展示
  - 容器资源使用统计表格
  - 自动刷新（每 30 秒）
  - 手动刷新按钮

### 💾 数据库更新

- 新增 `system_metrics` 表 - 系统监控指标
- 新增 `container_metrics` 表 - 容器监控指标
- 新增 `network_traffic` 表 - 网络流量统计

### 📦 API 接口

- `GET /api/monitor/system` - 获取系统监控指标（历史数据）
- `GET /api/monitor/system/current` - 获取当前系统监控指标
- `GET /api/monitor/containers` - 获取容器监控指标
- `GET /api/monitor/traffic` - 获取网络流量统计
- `GET /api/monitor/stats` - 获取资源使用统计
- `GET /api/monitor/dashboard` - 获取监控仪表板数据

### 📈 项目进展

- 功能完整度：65% → 80%
- 代码行数：+840 行
- 二进制文件：16MB（无变化）
- API 端点：12 → 18

### 📝 已知限制

- 未实现 Chart.js 图表
- 未实现容器级别的监控数据采集
- 不支持监控告警
- 不支持数据导出

---

## [3.0.0-stage3] - 2026-01-04 - 第3阶段完成

### 🎉 重大更新

实现了完整的配额限制系统，包括IP地址配额、端口映射配额、反向代理配额、流量配额和配额超限处理。

### ✨ 新功能

- **配额管理核心模块**
  - 配额创建和更新
  - 配额使用情况统计
  - 配额检查和限制
  - 流量统计和重置

- **配额类型**
  - IPv4 地址配额
  - IPv6 地址配额
  - 端口映射配额
  - 反向代理配额
  - 流量配额（GB）

- **配额超限处理**
  - warn 模式：记录警告日志
  - limit 模式：限制新资源分配
  - stop 模式：自动停止容器

- **配额检查集成**
  - IP地址分配前检查
  - 端口映射创建前检查
  - 反向代理创建前检查

- **Web 管理界面**
  - 配额管理页面
  - 配额设置和编辑
  - 配额使用情况展示
  - 流量重置功能

### 💾 数据库更新

- 完善 `quotas` 表 - 配额设置和统计

### 📦 API 接口

- `GET/POST/PUT/DELETE /api/quota` - 配额管理
- `GET /api/quota/usage` - 配额使用情况
- `GET /api/quota/stats` - 配额统计信息
- `POST /api/quota/reset-traffic` - 重置流量统计

### 📈 项目进展

- 功能完整度：50% → 65%
- 代码行数：+870 行
- 二进制文件：16MB（无变化）

### 📝 已知限制

- stop 模式的容器停止功能未实现
- 不支持自动流量监控
- 不支持配额超限邮件通知
- 高并发情况下可能出现配额超限

---

## [3.0.0-stage2] - 2026-01-04 - 第2阶段完成

### 🎉 重大更新

实现了完整的网络管理系统，包括IP地址池、NAT端口映射、反向代理功能。

### ✨ 新功能

- **IP地址池管理**
  - IPv4/IPv6 地址分配和释放
  - 地址池管理（添加/删除地址段）
  - 地址状态跟踪
  - 容器 IP 地址绑定

- **NAT端口映射**
  - 单端口映射
  - 端口段映射（批量映射）
  - 随机端口分配
  - iptables 规则自动管理
  - 端口可用性检查

- **反向代理**
  - Nginx 配置自动生成
  - 域名绑定到容器
  - SSL/HTTPS 支持
  - WebSocket 支持
  - 配置热重载

- **Web 管理界面**
  - IP地址池管理页面
  - 端口映射管理页面
  - 反向代理管理页面
  - 实时数据刷新

### 💾 数据库更新

- 新增 `ip_addresses` 表 - IP地址信息
- 新增 `port_mappings` 表 - 端口映射信息
- 新增 `proxy_configs` 表 - 反向代理配置

### 📦 API 接口

- `GET/POST/DELETE /api/network/ippool` - IP地址池管理
- `GET/POST/DELETE /api/network/portmapping` - 端口映射管理
- `GET/POST/PUT/DELETE /api/network/proxy` - 反向代理管理
- `GET /api/network/stats` - 网络统计信息

### 📈 项目进展

- 功能完整度：20% → 50%
- 代码行数：+2,050 行
- 二进制文件：15MB → 16MB

### 📝 已知限制

- 需要 root 权限执行 iptables 命令
- 反向代理功能需要安装 Nginx
- 不支持自动 SSL 证书（Let's Encrypt）
- 不支持负载均衡

---

## [3.0.0] - 2026-01-04 - 第1阶段完成

### 🎉 重大更新

这是一个完全重写的版本，移除了所有 Mock 数据，实现了真实的 LXD 集成。

### ✨ 新功能

- **真实 LXD 集成**
  - 使用 canonical/lxd 官方客户端库
  - 支持通过 Unix Socket 连接 LXD
  - 自动同步 LXD 容器到数据库
  - 实时获取容器状态和 IP 地址

- **模块化代码结构**
  - `internal/config` - 配置管理模块
  - `internal/models` - 数据库模型
  - `internal/lxd` - LXD 客户端封装
  - 清晰的代码组织，易于维护和扩展

- **完整的容器管理**
  - 创建容器（支持自定义 CPU、内存、磁盘）
  - 启动/停止/重启容器
  - 删除容器
  - 重置容器密码
  - 重装容器系统
  - 获取容器详情和实时状态

- **数据库系统**
  - SQLite 数据库支持
  - 自动数据库迁移
  - 容器信息持久化
  - 操作日志记录
  - 为网络配置和配额系统预留表结构

### 🔧 技术改进

- **编译优化**
  - 升级到 Go 1.21.13
  - 静态链接编译，无 glibc 依赖
  - 二进制文件大小优化（15MB）

- **配置系统**
  - 支持多路径配置文件查找
  - 数据库路径可配置
  - LXD Socket 路径可配置

- **安全性**
  - HTTPS 支持
  - 自签名证书自动生成
  - API 认证中间件
  - 管理员登录验证

### 🗑️ 移除内容

- 移除所有 Mock 数据和示例代码
- 移除不存在的内部包依赖
- 清理无用的代码和注释

### 📝 已知限制

这是第1阶段的完成版本，以下功能将在后续阶段实现：

- **第2阶段**：网络管理系统（独立IP、NAT、反向代理）
- **第3阶段**：配额限制系统
- **第4阶段**：实时监控和图表
- **第5阶段**：高级功能（VNC、热更新、DNS）

### 🐛 Bug 修复

- 修复配置文件路径查找问题
- 修复证书目录不存在的错误
- 修复 glibc 版本兼容性问题
- 修复 Web 界面 404 错误

---

## [2.0.0] - 2025-01-04

### 新增 ✨
- 完全开源的 LXD 容器管理后端
- RESTful API (100% 兼容原版)
- Web 管理界面
- 财务系统插件（WHMCS/魔方财务/FOSSBilling/SwapIDC）
- 一键安装脚本
- 管理工具 CLI (19项功能)
- 自动备份和健康检查
- 完整的文档系统

### 核心功能 🎯
- 容器生命周期管理
- 资源限制与配额控制
- 网络管理（NAT/IP池）
- 流量统计与控制
- 数据持久化（SQLite）
- 安全认证（API Key）

[3.0.0]: https://github.com/areyouokbro/openlxd/releases/tag/v3.0.0
[2.0.0]: https://github.com/areyouokbro/openlxd/releases/tag/v2.0.0
